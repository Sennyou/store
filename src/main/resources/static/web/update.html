<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/update.css">
    <link rel="stylesheet" href="css/head.css">
    <link rel="stylesheet" href="css/updatePassword.css">
    <link rel="stylesheet" href="css/updateUserInfo.css">
    <script src="jquery-3.4.1.min.js"></script>
    <script src="jquery.cookie.js"></script>
</head>
<script>
    function verifypassword() {
        let password = $("#password").val();
        let verPassword = $("#verPassword").val();
        if (password == verPassword) {
            $("#ok").removeClass("error");
            $('#ok').addClass("ok");
        } else {
            $("#ok").removeClass("ok");
            $('#ok').addClass("error");
        }
    }
</script>
<body>
<!-- #include file="b.html" -->
<div class="head w">
    <div class="img">
        <div style="border: none;outline: none;height: 80px">
            <img src="image/logo.png" height="80px" width="80px" alt="">
        </div>
        <div>
            <img src="image/logo_wenzi.png" width="200px" height="35px" style="margin: 20px auto auto 10px" alt="">
        </div>
    </div>
    <div class="daohang">
        <div><a href="index.html">首页</a></div>
        <div><a href="">购物车</a></div>
        <div><a href="">收藏</a></div>
    </div>

    <div class="input">
        <input type="text" name="findValue" placeholder="请输入关键字">
        <button class="button"></button>
    </div>
    <div class="userinfo">
        <a href="">登录/注册</a>
    </div>

</div>
<div class="box">
    <div class="content">
        <div class="ele">
            <ul>
                <li class="active"><a href="#">修改密码</a></li>
                <li><a href="#">修改用户信息</a></li>
                <li><a href="#">更换头像</a></li>
            </ul>
        </div>
        <!--修改密码-->
        <div class="elec password" style="display: block">
            <form class="update-form">
                <div class="input">
                    <input type="text" name="oldPassword" placeholder="原密码">
                </div>
                <div class="input">
                    <input type="password" name="newPassword" id="password" placeholder="新密码">
                </div>
                <div class="input">
                    <input type="password" id="verPassword" placeholder="确认密码" onchange="verifypassword()">
                    <div id="ok"></div>
                </div>
                <div class="button">
                    <input id="changePassword" type="button" class="button" value="确认">
                </div>
            </form>
        </div>
        <!--修改用户信息-->
        <div class="elec userinfo" style="display: none">
            <form class="update-form" >
                <div class="input">
                    <input id="phone" type="text" name="phone" placeholder="手机号">
                </div>
                <div class="input">
                    <input id="email" type="text" name="emial" placeholder="邮箱">
                </div>
                <div class="button">
                    <input id="changeUserInfo" type="button" class="button" value="确认">
                </div>
            </form>
        </div>
        <!--更换头像-->
        <div class="elec avatar" style="display: none">
            <form class="update-form" >
                <label>上传头像:</label>
                <input type="file" name="file">
                <input id="avatarUpload" type="button" value="上传">
                <img id="img-avatar" src="image/logo.png" style="height: 150px;width: 150px" alt="">
            </form>
        </div>

    </div>
</div>

</body>
<script type="application/javascript">
    $(document).ready(function (){
        <!--    在页面加载时,取出cookie中的图片地址,将其设置到用户头像img上-->
        let avatar = $.cookie("avatar");
        $("#img-avatar").attr("src",avatar);
        // 将用户信息填充到表单上
        $.ajax({
            url: '/user/findUserByUid',
            type: 'GET',
            data: "",
            //dataType: "json",
            success: function (json) {
                if (json.state == 200) {
                    alert("获取成功!" + json.data);
                    let phone = json.data.phone;
                    let email = json.data.emial;
                    $("#phone").val(phone);
                    $("#email").val(email);
                //    如果我们这里有性别
                //     let radio = json.data.gander == 0 ? $("#female") : $("#male");
                //    选择器.prop(属性,值),给某个元素添加某个属性和值
                //     radio.prop("checked","checked");
                } else {
                    alert("用户不存在! state:" + json.state + "  message=" + json.message);
                }
            },//当失败时,返回的数据类型是一个xhr
            error: function (xhr) {
                alert("网络连接失败!" + xhr.status);
            }
        });
    });
    //上传头像的ajax点击事件
    $("#avatarUpload").click(function () {
        console.log($(".avatar .update-form")[0]);
        $.ajax({
            url: '/user/updateUserAvatar',
            type: 'POST',
            data: new FormData($(".avatar .update-form")[0]),//[],里是表单下的第几个元素
            processData: false, //处理数据的形式,关闭处理数据
            contentType: false,//提交数据的形式,关闭
            //dataType: "json",
            success: function (json) {
                let jsonResult;
                if (json.state == 200) {
                    alert("头像修改成功!" + json.data);
                    //将服务器返回的头像地址设置到img的src属性上
                    //attr(属性,值)给某个属性设置某个值
                    $("#img-avatar").attr("src",json.data);
                    //修改当前cookie中的avatar
                    $.cookie("avatar",json.data,{expires:7});
                } else {
                    //jsonResult = jQuery.parseJSON(json); 在定义dataType="json"后,就不需要这个了
                    //其实本身也不需要,他自动识别类型
                    alert("上传失败! state:" + json.state + "  message=" + json.message);
                }
            },//当失败时,返回的数据类型是一个xhr
            error: function (xhr) {
                alert("网络连接失败!" + xhr.status);
            }
        });
    });

//    更改密码的ajax点击事件
    $("#changePassword").click(function (){
        $.ajax({
                url: '/user/changePassword',
                type: 'POST',
                data: $(".password .update-form").serialize(),
                success: function (json) {
                if (json.state == 200) {
                    alert("修改成功!" + json.data);
                } else {
                    alert("修改失败! state:" + json.state + "  message=" + json.message);
                }
            },//当失败时,返回的数据类型是一个xhr
            error: function (xhr) {
                alert("网络连接失败!" + xhr.status);
            }
        });
    });

//修改用户信息的ajax点击事件
    $("#changeUserInfo").click(function (){
        $.ajax({
            url: '/user/updateUserInfo',
            type: 'POST',
            data: $(".userinfo .update-form").serialize(),
            success: function (json) {
                let jsonResult;
                if (json.state == 200) {
                    alert("修改成功!" + json.data);
                    location.href = "index.html";
                } else {
                    alert("修改失败! state:" + json.state + "  message=" + json.message);
                }
            },//当失败时,返回的数据类型是一个xhr
            error: function (xhr) {
                alert("网络连接失败!" + xhr.status);
            }
        });
    });
</script>
<script type="text/javascript">
    window.onload = function () {
        let obtn = document.getElementsByTagName("li");
        let oElec = document.getElementsByClassName("elec");

        let i = 0;

        for (i = 0; i < obtn.length; i++) {
            obtn[i].index = i;//记录索引值
            obtn[i].onclick = function () {
                for (let j = 0; j < obtn.length; j++) {
                    obtn[j].className = "";
                    oElec[j].style.display = 'none';
                }
                this.className = "active";
                oElec[this.index].style.display = "block";
                console.log("1")
            };
        }
    };
</script>

</html>